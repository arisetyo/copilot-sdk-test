<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Assisted Registration</title>
  <link rel="stylesheet" href="/public/css/styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container-wide" x-data="registrationApp()">
    <header>
      <a href="/" class="back-link">← Back to home</a>
      <h1>AI-Assisted Registration</h1>
      <p class="subtitle">Describe yourself and let the AI fill the form for you</p>
    </header>

    <main class="two-column-layout">
      <!-- Left Column: Form Fields -->
      <section class="fields-panel">
        <h2>Registration Fields</h2>
        <p class="panel-description">These fields will be populated by the AI based on your description.</p>

        <div class="field-display-list">
          <template x-for="field in fieldList" :key="field.key">
            <div class="field-display" :class="{ 'ai-suggested': form[field.key]?.aiSuggested }">
              <label x-text="field.label"></label>
              <div class="field-value">
                <template x-if="form[field.key]?.value">
                  <span>
                    <span class="filled-value" x-text="getDisplayValue(field.key, form[field.key].value)"></span>
                    <span class="ai-badge" x-show="form[field.key]?.aiSuggested">AI</span>
                  </span>
                </template>
                <template x-if="!form[field.key]?.value">
                  <span class="empty-value">Not set</span>
                </template>
              </div>
              <div class="field-options" x-show="field.options" x-text="field.options"></div>
            </div>
          </template>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-primary" 
            :disabled="!canSubmit"
            @click="submitForm"
          >
            Submit Registration
          </button>
          <button type="button" class="btn btn-secondary" @click="clearForm">
            Clear All
          </button>
        </div>
      </section>

      <!-- Right Column: AI Chat Interface -->
      <section class="chat-panel">
        <h2>AI Assistant</h2>
        <p class="panel-description">Tell me about yourself and I'll help fill in the form.</p>

        <!-- Chat Messages Container -->
        <div class="chat-messages" x-ref="chatMessages">
          <template x-for="(msg, index) in messages" :key="index">
            <div class="message" :class="'message-' + msg.type">
              <div class="message-content">
                <template x-if="msg.streaming">
                  <span>
                    <span x-html="msg.content"></span>
                    <span class="typing-cursor">▋</span>
                  </span>
                </template>
                <template x-if="!msg.streaming">
                  <span x-html="msg.content"></span>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
          <textarea 
            x-model="userInput"
            @keydown.enter.prevent="!$event.shiftKey && sendMessage()"
            class="chat-input" 
            placeholder="Describe yourself here..."
            rows="3"
          ></textarea>
          <button 
            type="button" 
            class="btn btn-primary" 
            @click="sendMessage"
            :disabled="!userInput.trim() || isStreaming"
          >
            Ask AI
          </button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /**
     * Alpine.js component for the AI-assisted registration form.
     * Replaces vanilla JS with reactive data bindings.
     */
    function registrationApp() {
      return {
        /** Field options from server */
        fieldOptions: <%- JSON.stringify(fieldOptions) %>,

        /** Accommodation packages from server */
        accommodations: <%- JSON.stringify(accommodations) %>,

        /** Field definitions for rendering */
        fieldList: [
          { key: 'full_name', label: 'Full Name' },
          { key: 'email', label: 'Email' },
          { key: 'city', label: 'City' },
          { key: 'institution', label: 'Institution', options: 'Options: <%= fieldOptions.institutions.join(", ") %>' },
          { key: 'role', label: 'Role', options: 'Depends on institution' },
          { key: 'position', label: 'Position', options: 'Depends on institution' },
          { key: 'accommodation', label: 'Accommodation', options: 'Budget ($50), Standard ($80), Business ($120), Premium ($180)' },
        ],

        /** Form state - each field has { value, aiSuggested } */
        form: {
          full_name: { value: null, aiSuggested: false },
          email: { value: null, aiSuggested: false },
          city: { value: null, aiSuggested: false },
          institution: { value: null, aiSuggested: false },
          role: { value: null, aiSuggested: false },
          position: { value: null, aiSuggested: false },
          accommodation: { value: null, aiSuggested: false },
        },

        /** Chat messages array */
        messages: [
          {
            type: 'assistant',
            content: `<p>Hello! I'm here to help you complete the registration form.</p>
              <p>Tell me about yourself — for example:</p>
              <ul>
                <li>"I'm Dr. Sarah Chen, a researcher at Stanford University"</li>
                <li>"My name is John and I work in QA at a tech company in Seattle"</li>
                <li>"I'm a nurse at City Hospital in Jakarta"</li>
              </ul>
              <p>I can also help you choose an accommodation package if you ask about rooms or budget options!</p>
              <p>I'll extract the relevant information and fill in the form fields for you.</p>`,
            streaming: false,
          },
        ],

        /** User input binding */
        userInput: '',

        /** Streaming state */
        isStreaming: false,

        /** Computed: check if required fields are filled */
        get canSubmit() {
          const required = ['full_name', 'email', 'institution', 'role', 'position'];
          return required.every(key => this.form[key]?.value);
        },

        /**
         * Update a form field value
         * @param {string} key - Field name
         * @param {string|null} value - Field value
         * @param {boolean} aiSuggested - Whether value came from AI
         */
        setField(key, value, aiSuggested = false) {
          this.form[key] = { value, aiSuggested };
        },

        /**
         * Get display value for a field (handles special formatting like accommodation)
         * @param {string} key - Field key
         * @param {any} value - Field value
         * @returns {string} - Display value
         */
        getDisplayValue(key, value) {
          if (key === 'accommodation' && typeof value === 'number') {
            const pkg = this.accommodations.find(a => a.packageId === value);
            return pkg ? `${pkg.name} (${pkg.cost})` : value;
          }
          return value;
        },

        /** Clear all form fields */
        clearForm() {
          Object.keys(this.form).forEach(key => {
            this.form[key] = { value: null, aiSuggested: false };
          });
          this.addMessage('<p><em>Form cleared. Tell me about yourself to start again.</em></p>', 'assistant');
        },

        /** Submit the form (shows confirmation for now) */
        submitForm() {
          const data = {};
          Object.keys(this.form).forEach(key => {
            data[key] = this.form[key]?.value;
          });
          this.addMessage(
            `<p>✅ <strong>Registration submitted!</strong></p><pre>${JSON.stringify(data, null, 2)}</pre>`,
            'assistant'
          );
        },

        /**
         * Add a message to chat
         * @param {string} content - HTML content
         * @param {string} type - 'user' or 'assistant'
         * @param {boolean} streaming - Whether message is still streaming
         */
        addMessage(content, type, streaming = false) {
          this.messages.push({ type, content, streaming });
          this.$nextTick(() => this.scrollToBottom());
        },

        /** Scroll chat container to bottom */
        scrollToBottom() {
          if (this.$refs.chatMessages) {
            this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
          }
        },

        /** Send message to AI form assistant with SSE streaming */
        async sendMessage() {
          const message = this.userInput.trim();
          if (!message || this.isStreaming) return;

          // Add user message
          this.addMessage(`<p>${message}</p>`, 'user');
          this.userInput = '';
          this.isStreaming = true;

          // Add streaming placeholder
          const streamingIndex = this.messages.length;
          this.messages.push({ type: 'assistant', content: '', streaming: true });

          // Get current form values to provide context
          const currentForm = {};
          Object.keys(this.form).forEach(key => {
            currentForm[key] = this.form[key]?.value || null;
          });

          try {
            const response = await fetch('/ai/assist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: message, currentForm }),
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              let eventType = '';
              for (const line of lines) {
                if (line.startsWith('event: ')) {
                  eventType = line.slice(7);
                } else if (line.startsWith('data: ')) {
                  const data = JSON.parse(line.slice(6));

                  if (eventType === 'delta' && data.text) {
                    // Just show a simple "thinking" indicator (hide raw JSON)
                    this.messages[streamingIndex].content = '<p class="thinking-text">Extracting information...</p>';
                  } else if (eventType === 'result') {
                    // AI returned structured result - update form and show message
                    if (data.fields) {
                      this.applyFields(data.fields);
                    }
                    // Replace thinking text with final message
                    this.messages[streamingIndex].content = marked.parse(data.message || 'Done!');
                    this.messages[streamingIndex].streaming = false;
                  } else if (eventType === 'error') {
                    throw new Error(data.message);
                  }
                }
              }
            }

            // Finalize if not already done by result event
            if (this.messages[streamingIndex].streaming) {
              this.messages[streamingIndex].streaming = false;
              if (!this.messages[streamingIndex].content) {
                this.messages[streamingIndex].content = '<em>No response received from AI.</em>';
              }
            }
          } catch (err) {
            this.messages[streamingIndex].streaming = false;
            this.messages[streamingIndex].content = `<span class="error-text">Error: ${err.message}</span>`;
          } finally {
            this.isStreaming = false;
          }
        },

        /**
         * Apply AI-extracted fields to the form
         * @param {object} fields - Validated field values from AI
         */
        applyFields(fields) {
          if (!fields) return;

          Object.keys(fields).forEach(key => {
            if (fields[key] !== null && this.form.hasOwnProperty(key)) {
              this.form[key] = { value: fields[key], aiSuggested: true };
            }
          });
        },
      };
    }
  </script>
</body>
</html>
